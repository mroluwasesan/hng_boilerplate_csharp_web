name: Release

on:
  push:
    branches:
      - releases

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get the current date and time
        id: date
        run: echo "TAG_NAME=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: Create Tag
        run: |
          git tag ${{ env.TAG_NAME }}
          git push origin ${{ env.TAG_NAME }}

      - name: Generate Release Notes
        id: generate_notes
        uses: actions/github-script@v6
        with:
          script: |
            const { context, github } = require('@actions/github');
            const { data: commits } = await github.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
            });

            const releaseDate = new Date().toLocaleString();
            const releaseTitle = `ðŸš€ Release ${{ env.TAG_NAME }} - ${releaseDate}`;

            const releaseNotes = `
            ## ${releaseTitle}
            **Release Date:** ${releaseDate}

            ### ðŸ“ Summary
            A new release has been created with the following changes:

            ### ðŸ“‹ Commits
            ` + commits.map(commit => {
              return `- **${commit.commit.message.split('\n')[0]}**\n  - Author: ${commit.commit.author.name}\n  - Commit: [${commit.sha.substring(0, 7)}](${commit.html_url})\n`;
            }).join('\n') + `
            
            ### ðŸ”— Additional Information
            For more details, visit the [repository](${context.payload.repository.html_url}).

            ---

            _Generated by [GitHub Actions](https://github.com/features/actions)_
            `;

            return { releaseNotes };

      - name: Create Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: "ðŸš€ Release ${{ env.TAG_NAME }}"
          body: ${{ steps.generate_notes.outputs.releaseNotes }}
          draft: false
          prerelease: false
